package com.together.web.login;

import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.security.auth.message.callback.PrivateKeyCallback.Request;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.ibatis.session.SqlSession;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.ModelAndView;

@Controller
public class UserController {
	// mybatis 객체 의존성 (자동) 주입 !
	@Autowired
	private SqlSession sqlSession;

	// login 컨트롤러
	@RequestMapping(value = "/login.action")
	public String login(UserDTO dto, HttpSession session, HttpServletRequest request) {

		int userId = 0;
		IUserDAO dao = sqlSession.getMapper(IUserDAO.class);

		userId = dao.login(dto);

		if (userId != 0) {
			// 로그인 성공
			session = request.getSession();
			// session.setAttribute("sessionId", dto.getSessionId());
			session.setAttribute("userId", userId);
			return "WEB-INF/views/main/afterLogin.jsp";
		} else
			return "WEB-INF/views/login/Login.jsp";

	}
	
	// 아이디 중복확인
	@RequestMapping(value = "/idcheck.action")
	public void idCheck(String userId, HttpServletResponse response) throws IOException
	{
		int result = 0;
		IUserDAO dao = sqlSession.getMapper(IUserDAO.class);
		result = dao.checkId(userId);
		response.getWriter().print(result);
	}

	// 닉네임 중복확인
	@RequestMapping(value = "/nicknamecheck.action")
	public void nicknameCheck(String nickName, HttpServletResponse response) throws IOException
	{
		int result = 0;
		IUserDAO dao = sqlSession.getMapper(IUserDAO.class);
		result = dao.checkNickname(nickName);
		response.getWriter().print(result);
		
	}
	
	// 이메일 중복확인
	@RequestMapping(value = "/emailcheck.action")
	public void emailCheck(String email, HttpServletResponse response) throws IOException
	{
		int result = 0;
		IUserDAO dao = sqlSession.getMapper(IUserDAO.class);
		result = dao.checkEmail(email);
		response.getWriter().print(result);
		
	}
	
	// 회원가입 성공 후 TBL_USER 테이블에 insert 
	@RequestMapping(value = "/joininsert.action")
	public String userInsert(UserDTO dto)
	{
		IUserDAO dao = sqlSession.getMapper(IUserDAO.class);
		
		dao.add(dto);
		
		int userCode = dao.searchUserCode(dto);
		
		Map<String, Integer> map = new HashMap<String, Integer>();
		
		for (int themaCode : dto.getThemaCode()) {
			map.put("userCode", userCode);
			map.put("themaCode", themaCode);
			dao.addUthema(map);
		}
		
		return "WEB-INF/views/login/JoinSuccess.jsp";
	}
	
	@RequestMapping(value = "/loginform.action")
	public String loginForm()
	{
		
		return "WEB-INF/views/login/JoinSuccess.jsp";
	}

}